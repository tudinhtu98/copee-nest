generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  username     String         @unique
  passwordHash String?        @map("password_hash") // Optional for OAuth users
  googleId     String?        @unique @map("google_id") // Google OAuth ID
  name         String?        // Full name from OAuth
  image        String?        // Profile image from OAuth
  role         UserRole       @default(USER)
  balance      Int            @default(0)
  bannedAt     DateTime?      @map("banned_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  products     Product[]
  sites        Site[]
  transactions Transaction[]
  refreshTokens RefreshToken[]
  apiKeys      ApiKey[]

  @@map("users")
}

model Site {
  id                    String                @id @default(cuid())
  userId                String                @map("user_id")
  name                  String
  baseUrl               String                @map("base_url")
  wooConsumerKey        String                @map("woo_consumer_key")
  wooConsumerSecret     String                @map("woo_consumer_secret")
  wpUsername            String?               @map("wp_username") // WordPress username for Application Password
  wpApplicationPassword String?               @map("wp_application_password") // WordPress Application Password (encrypted)
  shopeeAffiliateId     String?               @map("shopee_affiliate_id") // Shopee Affiliate ID for converting product links
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")
  user                  User                  @relation(fields: [userId], references: [id])
  uploads               UploadJob[]
  wooCommerceCategories WooCommerceCategory[]

  @@map("sites")
}

model Product {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  sourceShop    String        @map("source_shop")
  sourceUrl     String        @map("source_url")
  title         String
  description   String?
  images        Json?
  price         Int?          // Sale price (giá đã giảm)
  originalPrice Int?          @map("original_price") // Regular price (giá gốc)
  currency      String?
  category      String?
  status        ProductStatus @default(DRAFT)
  errorMessage  String?       @map("error_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  categoryId    String?       @map("category_id")
  needsMapping  Boolean       @default(false) @map("needs_mapping")
  user          User          @relation(fields: [userId], references: [id])
  uploads       UploadJob[]

  @@map("products")
}

model UploadJob {
  id             String    @id @default(cuid())
  productId      String    @map("product_id")
  siteId         String    @map("site_id")
  targetCategory String?   @map("target_category")
  payload        Json?
  result         Json?
  status         String    @default("PENDING")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  lastRetryAt    DateTime? @map("last_retry_at")
  retryCount     Int       @default(0) @map("retry_count")
  product        Product   @relation(fields: [productId], references: [id])
  site           Site      @relation(fields: [siteId], references: [id])

  @@map("upload_jobs")
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int
  type        String
  description String?
  reference   String?
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id])

  @@map("transactions")
}

model WooCommerceCategory {
  id               String            @id @default(cuid())
  siteId           String            @map("site_id")
  wooId            String            @map("woo_id")
  name             String
  slug             String?
  parentId         String?           @map("parent_id")
  count            Int               @default(0)
  syncedAt         DateTime          @default(now()) @map("synced_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  site             Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, wooId])
  @@map("woocommerce_categories")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique // Hashed API key
  name        String    // User-defined name for the key
  userId      String    @map("user_id")
  permissions String[]  // Array of permissions: ["products:read", "products:write"]
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at") // Optional expiration
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
  @@map("api_keys")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  userEmail   String   @map("user_email")
  userRole    UserRole @map("user_role")
  action      String   // e.g., "CREATE_SITE", "DELETE_PRODUCT", "UPDATE_USER"
  resource    String   // e.g., "Site", "Product", "User"
  resourceId  String?  @map("resource_id") // ID của resource bị thao tác
  method      String   // HTTP method: GET, POST, PATCH, DELETE
  endpoint    String   // API endpoint được gọi
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  requestBody Json?    @map("request_body") // Request payload (sensitive data filtered)
  response    Json?    // Response data (optional)
  status      Int      // HTTP status code
  errorMessage String? @map("error_message")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}


enum UserRole {
  USER
  MOD
  ADMIN
}

enum ProductStatus {
  DRAFT
  READY
  UPLOADED
  FAILED
}
